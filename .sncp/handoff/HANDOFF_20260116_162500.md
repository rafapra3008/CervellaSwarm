# HANDOFF - Sessione 240

> **Data:** 16 Gennaio 2026
> **Commit:** 0a0fb3a
> **Progetto:** CervellaSwarm

---

## COSA È STATO FATTO

### Sprint 3 Stripe - 70% Completato

**1. Backend API (packages/api/) - NUOVO!**

```
packages/api/
├── src/
│   ├── index.ts              # Express server porta 3001
│   ├── routes/
│   │   ├── checkout.ts       # POST /api/create-checkout-session
│   │   ├── portal.ts         # POST /api/create-portal-session
│   │   ├── subscription.ts   # GET /api/subscription/:id
│   │   └── webhooks.ts       # POST /webhooks/stripe (5 handlers)
│   ├── db/index.ts           # JSON database (lowdb, no compilazione)
│   └── utils/stripe.ts       # Stripe client + helpers
├── Dockerfile                # Multi-stage build Node 20
├── fly.toml                  # Frankfurt region, $5/mo
└── package.json              # Dipendenze: stripe, express, lowdb
```

**2. CLI Commands**

```javascript
// packages/cli/src/commands/upgrade.js
cervellaswarm upgrade pro   // $20/mo, 500 calls
cervellaswarm upgrade team  // $35/mo, 1000 calls
// Apre Stripe Checkout nel browser, poll per conferma

// packages/cli/src/commands/billing.js
cervellaswarm billing         // Apre Customer Portal
cervellaswarm billing --status  // Mostra tier corrente
```

**3. Config Manager Esteso**

```javascript
// packages/cli/src/config/manager.js
// Nuovi campi aggiunti:
- tier: 'free' | 'pro' | 'team' | 'enterprise'
- customerId: string
- subscriptionId: string
- email: string
- lastSync: timestamp

// Nuove funzioni:
- getTier(), setTier()
- getCustomerId(), setCustomerId()
- updateSubscriptionData()
- needsSync() // true se > 24h
```

---

## COSA MANCA (30%)

### 1. Stripe Dashboard (CON RAFA!)

Rafa ha bisogno di aiuto per creare i prodotti:

```
STEP:
1. Login su dashboard.stripe.com
2. Products → Add product
3. Creare "CervellaSwarm Pro"
   - Price: $20 USD
   - Billing period: Monthly
   - Copiare il Price ID (price_xxx)
4. Creare "CervellaSwarm Team"
   - Price: $35 USD
   - Billing period: Monthly
   - Copiare il Price ID (price_xxx)
```

### 2. Deploy Fly.io

```bash
cd packages/api

# 1. Login
fly auth login

# 2. Launch (prima volta)
fly launch --name cervellaswarm-api

# 3. Creare volume per database
fly volumes create cervellaswarm_data --size 1

# 4. Configurare secrets
fly secrets set STRIPE_SECRET_KEY=sk_test_xxx
fly secrets set STRIPE_WEBHOOK_SECRET=whsec_xxx
fly secrets set STRIPE_PRICE_PRO=price_xxx
fly secrets set STRIPE_PRICE_TEAM=price_xxx
fly secrets set FRONTEND_URL=https://cervellaswarm.com

# 5. Deploy
fly deploy
```

### 3. Test End-to-End

```bash
# 1. Test upgrade
cervellaswarm upgrade pro
# → Apre browser con Stripe Checkout
# → Usare carta test: 4242 4242 4242 4242, exp 12/34, cvc 123

# 2. Verifica webhook ricevuto
fly logs

# 3. Verifica tier aggiornato
cervellaswarm billing --status
```

---

## DECISIONI PRESE

| Decisione | Perché |
|-----------|--------|
| Fly.io $5/mo | Container sempre attivo (no cold start per webhook) |
| lowdb invece di SQLite | Zero compilazione nativa, funziona ovunque |
| JSON database | Abbastanza per pochi utenti, può scalare dopo |
| Frankfurt region | Vicino all'Italia |

---

## FILE CHIAVE

| File | Descrizione |
|------|-------------|
| `packages/api/src/routes/webhooks.ts` | 5 webhook handlers Stripe |
| `packages/api/fly.toml` | Config deploy Fly.io |
| `packages/cli/src/commands/upgrade.js` | Comando upgrade |
| `packages/cli/src/config/manager.js` | Gestione tier locale |
| `.sncp/progetti/cervellaswarm/idee/STUDIO_STRIPE_INTEGRATION_CLI.md` | Report ricerca 988 righe |

---

## MAPPA SESSIONI

```
237: MCP funziona + Dual-Mode + Freemium
 |
238: Sprint 1 BYOK Polish COMPLETATO
 |
239: Sprint 2 Metering COMPLETATO + Context Guard discovery
 |
240: Sprint 3 Stripe IN CORSO (backend + CLI pronti)  <-- OGGI!
 |
241: Sprint 3 Stripe COMPLETAMENTO (Dashboard + Deploy + Test)
 |
242: Sprint 4 Sampling Implementation
```

---

## PER LA PROSSIMA CERVELLA

1. **Prima cosa:** Aiuta Rafa con Stripe Dashboard (ha gli screenshot!)
2. **Poi:** Deploy su Fly.io
3. **Infine:** Test end-to-end

**IMPORTANTE:** Il codice è PRONTO. Manca solo configurazione e deploy!

---

*"Un progresso al giorno = 365 progressi all'anno!"*

Sessione 240 chiusa.
