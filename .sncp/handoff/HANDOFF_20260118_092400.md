# HANDOFF - Sessione 258

> **Data:** 18 Gennaio 2026 - 09:24
> **Progetto:** Miracollo PMS
> **Focus:** VCC Booking.com + Problema Deploy

---

## COSA ABBIAMO FATTO

### 1. VCC Booking.com - IMPLEMENTATO

```
Backend:
- backend/services/stripe_service.py
  + charge_vcc_payment() - addebito VCC via Stripe

- backend/routers/payments.py
  + GET /api/payments/stripe-config (chiave pubblica)
  + POST /api/payments/charge-vcc (addebito)

Frontend:
- frontend/planning.html
  + Stripe.js v3 caricato da CDN

- frontend/js/planning/modal-payment.js (v1.0 → v2.0)
  + Sezione VCC con Stripe Elements
  + Bottone "VCC Booking" (blu, stile Booking.com)
  + showVCCSection(), chargeVCC(), hideVCCSection()

- frontend/js/planning/config.js
  + stripePublicKey in CONFIG
```

### 2. Stripe Sandbox Miracollo - CONFIGURATO

```
Account:      acct_1Sqrxk7aXUHP1bna
Business:     Miracollo sandbox
Country:      IT

Chiavi (TEST MODE):
pk_test_51Sqrxk7aXUHP1bna...
sk_test_51Sqrxk7aXUHP1bna...

Test pagamento: OK (pi_3Sqs097aXUHP1bna1gt0l6g1)
```

### 3. Deploy - PROBLEMA EMERSO

```
Commit: cbf60c2
Deploy: OK (codice su VM)
Chiavi: OK (aggiunte a .env server)

MA: Il planning non carica!
```

---

## PROBLEMA DA RISOLVERE

```
ERRORE NEI LOGS:
sqlite3.OperationalError: no such column: imported
File: backend/routers/cm_reservation.py:416

SINTOMO:
- /api/planning/NL → 404
- /api/cm/reservations/count → 500

CAUSA:
La query cerca una colonna 'imported' che non esiste nel DB.
NON è causato dal codice VCC!

FIX SUGGERITO:
1. Verificare schema.sql per colonna 'imported'
2. Aggiungere colonna se mancante:
   ALTER TABLE cm_reservations ADD COLUMN imported INTEGER DEFAULT 0;
3. O rollback se c'è codice non committato
```

---

## FILE CHIAVE

| File | Cosa Contiene |
|------|---------------|
| `backend/services/stripe_service.py` | charge_vcc_payment() |
| `backend/routers/payments.py` | Endpoint VCC |
| `frontend/js/planning/modal-payment.js` | UI Stripe Elements |
| `.env` (server) | Chiavi Stripe |

---

## PROSSIMA SESSIONE

```
URGENTE (10 min):
1. ssh miracollo-vm
2. Verificare colonna 'imported' nel DB
3. Aggiungere se mancante
4. Riavviare backend

TEST VCC (dopo fix):
1. Aprire https://miracollo.com/planning.html
2. Cmd+Shift+R (hard refresh)
3. Aprire prenotazione → Pagamento → VCC Booking
4. Carta test: 4242 4242 4242 4242, 12/27, 123
5. Verificare addebito
```

---

## CONTESTO

- Stripe Elements = Zero PCI compliance
- Dati carta vanno direttamente a Stripe (iFrame)
- Miracollo riceve solo token
- Commissioni: 1.4% + €0.25 per transazione

---

*"Lavoriamo in pace! Senza casino! Dipende da noi!"*
