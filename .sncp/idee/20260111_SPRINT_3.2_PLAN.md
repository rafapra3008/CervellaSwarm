# SPRINT 3.2: Setup Qdrant per RAG

> **Data Piano:** 11 Gennaio 2026 (Domenica)
> **Esecuzione:** Lunedi 13 Gennaio 2026 (GPU accesa)
> **Durata Stimata:** 1-2 giorni

---

## OBIETTIVO

Installare e configurare Qdrant su cervella-gpu per abilitare RAG (Retrieval Augmented Generation) in Cervella AI.

---

## PREREQUISITI

| Cosa | Stato | Note |
|------|-------|------|
| cervella-gpu running | Da verificare Lun 9:00 | Schedule automatico |
| Ollama funzionante | OK (qwen3:4b) | Testato Sprint 3.1 |
| Docker su cervella-gpu | Da verificare | Probabilmente gia' presente |
| Rete interna GCP | OK | miracollo -> cervella-gpu |

---

## DECISIONI TECNICHE (dalla ricerca)

| Decisione | Scelta | Perche |
|-----------|--------|--------|
| Vector DB | Qdrant via Docker | Setup semplice, prod-ready |
| Embedding model | nomic-embed-text | 1024 dim, veloce, gratis |
| Architettura | Tutto su cervella-gpu | T4 16GB sufficiente |
| Chunking | 512 token, 15% overlap | Best practice |
| Sicurezza | Bind localhost + API key | No esposizione pubblica |

---

## STEP ESECUTIVI

### FASE 1: Verifica Infrastruttura (30 min)

```bash
# 1.1 Verifica GPU accesa
gcloud compute instances describe cervella-gpu \
  --zone=us-west1-b --project=data-frame-476309-v3 \
  --format='get(status)'
# Expected: RUNNING

# 1.2 Se spenta, accendi manualmente
gcloud compute instances start cervella-gpu \
  --zone=us-west1-b --project=data-frame-476309-v3

# 1.3 SSH e verifica Ollama
ssh cervella-gpu
ollama list
# Expected: qwen3:4b presente

# 1.4 Verifica Docker
docker --version
# Se non presente: sudo apt install docker.io docker-compose

# 1.5 Test API AI esistente
curl http://34.27.179.164:8001/api/ai/health
```

### FASE 2: Pull Embedding Model (10 min)

```bash
# Su cervella-gpu
ollama pull nomic-embed-text

# Test embedding
ollama embeddings --model nomic-embed-text --prompt "Test embedding"
# Expected: array di 1024 float
```

### FASE 3: Setup Qdrant (20 min)

```bash
# 3.1 Crea directory
mkdir -p ~/rag-setup
cd ~/rag-setup

# 3.2 Crea docker-compose.yml
cat > docker-compose.yml << 'EOF'
services:
  qdrant:
    image: qdrant/qdrant:latest
    restart: always
    container_name: qdrant
    ports:
      - "127.0.0.1:6333:6333"
      - "127.0.0.1:6334:6334"
    volumes:
      - ./qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY}
EOF

# 3.3 Genera API key
echo "QDRANT_API_KEY=$(openssl rand -hex 32)" > .env
cat .env  # Salva questa key!

# 3.4 Avvia Qdrant
docker compose up -d

# 3.5 Verifica
sleep 5
curl http://localhost:6333/healthz
# Expected: {"status":"ok"}
```

### FASE 4: Crea Collection (15 min)

```bash
# 4.1 Installa dipendenze Python
pip install qdrant-client ollama

# 4.2 Script creazione collection
cat > create_collection.py << 'EOF'
from qdrant_client import QdrantClient, models
import ollama
import os

# Load API key
from dotenv import load_dotenv
load_dotenv()

# Clients
oclient = ollama.Client()
qclient = QdrantClient(
    url="http://localhost:6333",
    api_key=os.getenv("QDRANT_API_KEY")
)

# Get embedding dimension
sample = oclient.embeddings(model="nomic-embed-text", prompt="test")
dim = len(sample["embedding"])
print(f"Embedding dimension: {dim}")

# Create collection
COLLECTION = "cervella_docs"
if not qclient.collection_exists(COLLECTION):
    qclient.create_collection(
        collection_name=COLLECTION,
        vectors_config=models.VectorParams(
            size=dim,
            distance=models.Distance.COSINE
        )
    )
    print(f"Collection '{COLLECTION}' created!")
else:
    print(f"Collection '{COLLECTION}' already exists")

# Verify
info = qclient.get_collection(COLLECTION)
print(f"Vectors: {info.points_count}")
EOF

# 4.3 Esegui
pip install python-dotenv
python create_collection.py
```

### FASE 5: Test End-to-End (15 min)

```bash
# 5.1 Script test base
cat > test_rag.py << 'EOF'
from qdrant_client import QdrantClient, models
import ollama
import os
from dotenv import load_dotenv

load_dotenv()

oclient = ollama.Client()
qclient = QdrantClient(
    url="http://localhost:6333",
    api_key=os.getenv("QDRANT_API_KEY")
)

COLLECTION = "cervella_docs"

def embed(text):
    return oclient.embeddings(model="nomic-embed-text", prompt=text)["embedding"]

# Add test document
print("Adding test document...")
qclient.upsert(
    collection_name=COLLECTION,
    points=[
        models.PointStruct(
            id=1,
            vector=embed("CervellaSwarm e' un sistema multi-agent con 16 Cervelle specializzate coordinate dalla Regina."),
            payload={"text": "CervellaSwarm e' un sistema multi-agent...", "source": "test"}
        ),
        models.PointStruct(
            id=2,
            vector=embed("SNCP significa Sistema Nervoso Centrale Progetti, e' la memoria esterna dello swarm."),
            payload={"text": "SNCP significa Sistema Nervoso Centrale...", "source": "test"}
        )
    ]
)

# Search
print("\nSearching for: 'cosa e' SNCP?'")
results = qclient.search(
    collection_name=COLLECTION,
    query_vector=embed("cosa e' SNCP?"),
    limit=2,
    with_payload=True
)

print("\nResults:")
for i, hit in enumerate(results, 1):
    print(f"  {i}. Score: {hit.score:.3f}")
    print(f"     {hit.payload['text']}")

print("\nâœ… RAG base funzionante!")
EOF

python test_rag.py
```

---

## VALIDAZIONE SPRINT

| Check | Comando | Expected |
|-------|---------|----------|
| Qdrant running | `curl localhost:6333/healthz` | `{"status":"ok"}` |
| Collection exists | `python -c "..."` | cervella_docs presente |
| Embedding works | `ollama embeddings ...` | Array 1024 float |
| Search works | `python test_rag.py` | Score > 0.7 per match |

---

## RISORSE

| Risorsa | Valore |
|---------|--------|
| Disco Qdrant | ~100 MB iniziale |
| RAM Qdrant | ~200 MB |
| VRAM nomic-embed | ~1-2 GB |
| VRAM totale | ~6-7 GB (50% T4) |

---

## OUTPUT ATTESI

1. Qdrant container running su cervella-gpu
2. Collection `cervella_docs` creata
3. Test search funzionante
4. API key salvata in .env

---

## NEXT SPRINT (3.3)

Dopo Sprint 3.2:
- Creare script ingest documenti
- Chunking pipeline
- Indicizzare docs CervellaSwarm
- Endpoint FastAPI /api/rag/query

---

*Piano creato: 11 Gennaio 2026 - Sessione 165*
*"Ultrapassar os proprios limites!"*
