#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  ALERTMANAGER CONFIGURATION
#  CervellaSwarm Alert System
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Global config
global:
  resolve_timeout: 5m

  # Telegram bot config
  telegram_api_url: 'https://api.telegram.org'

# Route tree per gestire gli alert
route:
  # Ricevitore di default
  receiver: 'telegram-default'

  # Grouping: raggruppa alert simili
  group_by: ['alertname', 'project', 'severity']
  group_wait: 10s        # Aspetta 10s prima di inviare gruppo
  group_interval: 5m     # Aspetta 5min prima di nuovo gruppo
  repeat_interval: 4h    # Ripeti alert ogni 4h se persiste

  # Routes specifiche per severity
  routes:
    # CRITICAL: invia subito, no grouping
    - match:
        severity: 'critical'
      receiver: 'telegram-critical'
      group_wait: 0s
      repeat_interval: 1h
      continue: true  # Continua anche altre route

    # WARNING: raggruppa e aspetta
    - match:
        severity: 'warning'
      receiver: 'telegram-default'
      group_wait: 30s
      repeat_interval: 12h

    # INFO: solo se persiste
    - match:
        severity: 'info'
      receiver: 'telegram-default'
      group_wait: 1m
      repeat_interval: 24h

# Receivers - Dove inviare gli alert
receivers:
  # Telegram - Default
  - name: 'telegram-default'
    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        api_url: 'https://api.telegram.org'
        parse_mode: 'HTML'
        message: |
          <b>ğŸ CervellaSwarm Alert</b>

          <b>Status:</b> {{ .Status | toUpper }}
          <b>Severity:</b> {{ .CommonLabels.severity }}
          <b>Alert:</b> {{ .CommonLabels.alertname }}

          {{ if .CommonLabels.project -}}
          <b>Project:</b> {{ .CommonLabels.project }}
          {{- end }}

          {{ if .CommonLabels.agent -}}
          <b>Agent:</b> {{ .CommonLabels.agent }}
          {{- end }}

          <b>Description:</b>
          {{ range .Alerts }}
          - {{ .Annotations.description }}
          {{ end }}

          <b>Time:</b> {{ .CommonAnnotations.timestamp }}

          {{ if .CommonAnnotations.action -}}
          <b>Action:</b> {{ .CommonAnnotations.action }}
          {{- end }}
        disable_notifications: false

  # Telegram - Critical (con notifica sonora)
  - name: 'telegram-critical'
    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        api_url: 'https://api.telegram.org'
        parse_mode: 'HTML'
        message: |
          <b>ğŸ”´ CRITICAL ALERT ğŸ”´</b>

          <b>Status:</b> {{ .Status | toUpper }}
          <b>Alert:</b> {{ .CommonLabels.alertname }}

          {{ if .CommonLabels.project -}}
          <b>Project:</b> {{ .CommonLabels.project }}
          {{- end }}

          {{ if .CommonLabels.agent -}}
          <b>Agent:</b> {{ .CommonLabels.agent }}
          {{- end }}

          <b>Description:</b>
          {{ range .Alerts }}
          - {{ .Annotations.description }}
          {{ end }}

          <b>Time:</b> {{ .CommonAnnotations.timestamp }}

          <b>âš ï¸ AZIONE IMMEDIATA RICHIESTA!</b>
          {{ if .CommonAnnotations.action -}}
          {{ .CommonAnnotations.action }}
          {{- end }}
        disable_notifications: false  # Notifica sonora attiva!

# Inhibition rules - Sopprime alert dipendenti
inhibit_rules:
  # Se servizio Ã¨ down, non mandare alert su metriche
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(HighErrorRate|LowSuccessRate|NoTasks)'
    equal: ['project', 'service']

  # Se database Ã¨ down, non mandare alert dipendenti
  - source_match:
      alertname: 'DatabaseDown'
    target_match_re:
      alertname: '(NoMetrics|StaleData)'
    equal: ['project']

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  TEMPLATE CUSTOM
#
#  Puoi aggiungere template custom in /etc/alertmanager/templates/
#  E usarli con: {{ template "custom.tmpl" . }}
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Templates (opzionale)
templates:
  - '/etc/alertmanager/templates/*.tmpl'

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  VARIABILI AMBIENTE RICHIESTE
#
#  TELEGRAM_BOT_TOKEN: Token del bot Telegram
#  TELEGRAM_CHAT_ID: ID della chat Telegram (numero)
#
#  Nota: Le variabili ${VAR} vengono sostituite da docker-compose
#        tramite envsubst o simile
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
