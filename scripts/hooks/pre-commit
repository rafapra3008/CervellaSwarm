#!/bin/bash
# =================================================================
# PRE-COMMIT HOOK - CervellaSwarm
# =================================================================
# BLOCCA il commit se:
# 1. File superano limiti di righe
# 2. Naming convention non rispettate
# =================================================================

# NOTA: NON usare "set -e" perche' ((VAR++)) con VAR=0 ritorna exit 1!

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ERRORS=0
WARNINGS=0

echo ""
echo "=================================================="
echo "  PRE-COMMIT CHECK"
echo "=================================================="

# =================================================================
# 1. VERIFICA LIMITI RIGHE (BLOCCANTE)
# =================================================================

check_line_limit() {
    local file="$1"
    local limit="$2"
    local name="$3"

    if [ -f "$file" ]; then
        lines=$(wc -l < "$file" | tr -d ' ')
        if [ "$lines" -gt "$limit" ]; then
            echo -e "${RED}ERRORE:${NC} $name ha $lines righe (limite: $limit)"
            echo "        File: $file"
            echo "        AZIONE: Archivia contenuto vecchio!"
            ((ERRORS++))
        elif [ "$lines" -gt $((limit * 9 / 10)) ]; then
            echo -e "${YELLOW}WARNING:${NC} $name ha $lines righe (90% del limite $limit)"
            ((WARNINGS++))
        fi
    fi
}

echo ""
echo ">> Verificando limiti righe..."

# PROMPT_RIPRESA (max 150)
for pr in .sncp/progetti/*/PROMPT_RIPRESA_*.md; do
    [ -f "$pr" ] && check_line_limit "$pr" 150 "$(basename "$pr")"
done

# oggi.md (max 60)
check_line_limit ".sncp/stato/oggi.md" 60 "oggi.md"

# stato.md (max 500)
for stato in .sncp/progetti/*/stato.md; do
    [ -f "$stato" ] && check_line_limit "$stato" 500 "$(basename $(dirname "$stato"))/stato.md"
done

# =================================================================
# 2. VERIFICA NAMING CONVENTION (WARNING + BLOCCANTE)
# =================================================================

echo ""
echo ">> Verificando naming convention..."

# Ottieni file staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

for file in $STAGED_FILES; do
    filename=$(basename "$file")

    # .sncp/ files naming check
    if [[ "$file" == .sncp/* ]]; then
        # PROMPT_RIPRESA deve avere nome progetto
        if [[ "$filename" == PROMPT_RIPRESA_* ]]; then
            if [[ ! "$filename" =~ ^PROMPT_RIPRESA_[a-z]+\.md$ ]]; then
                echo -e "${RED}ERRORE:${NC} PROMPT_RIPRESA naming errato: $filename"
                echo "        Deve essere: PROMPT_RIPRESA_{progetto}.md"
                ((ERRORS++))
            fi
        fi

        # Handoff deve avere numero sessione
        if [[ "$filename" == HANDOFF_* ]]; then
            if [[ ! "$filename" =~ ^HANDOFF_[0-9]+\.md$ ]]; then
                echo -e "${YELLOW}WARNING:${NC} HANDOFF naming: $filename (preferito: HANDOFF_NNN.md)"
                ((WARNINGS++))
            fi
        fi
    fi

    # reports/ files - preferisci data nel nome
    if [[ "$file" == reports/* ]] && [[ "$file" != reports/archive/* ]]; then
        if [[ "$filename" =~ \.md$ ]] || [[ "$filename" =~ \.json$ ]]; then
            # Warning se non ha data nel nome (non bloccante)
            if [[ ! "$filename" =~ [0-9]{8} ]] && [[ ! "$filename" =~ [0-9]{4}-[0-9]{2}-[0-9]{2} ]]; then
                echo -e "${YELLOW}HINT:${NC} Report senza data nel nome: $filename"
                echo "        Preferito: {tipo}_{YYYYMMDD}.{ext}"
            fi
        fi
    fi
done

# =================================================================
# 3. VERIFICA DOCS SYNC (Sessione 250 - Docs Sync System)
# =================================================================

echo ""
echo ">> Verificando docs sync..."

# Check if code files are being committed
CODE_CHANGED=$(echo "$STAGED_FILES" | grep -E "^packages/|^src/" || true)

if [ -n "$CODE_CHANGED" ]; then
    STATO_FILE=".sncp/progetti/cervellaswarm/stato.md"
    TODAY=$(date +%Y-%m-%d)

    # Check if stato.md is in staged files
    STATO_STAGED=$(echo "$STAGED_FILES" | grep "stato.md" || true)

    if [ -z "$STATO_STAGED" ] && [ -f "$STATO_FILE" ]; then
        # stato.md not staged, check last modification date
        if [[ "$OSTYPE" == "darwin"* ]]; then
            STATO_DATE=$(stat -f "%Sm" -t "%Y-%m-%d" "$STATO_FILE")
        else
            STATO_DATE=$(date -r "$STATO_FILE" +%Y-%m-%d)
        fi

        if [ "$STATO_DATE" != "$TODAY" ]; then
            echo -e "${YELLOW}WARNING:${NC} Codice modificato ma stato.md non aggiornato oggi!"
            echo "        Aggiorna .sncp/progetti/cervellaswarm/stato.md"
            echo "        Descrivi cosa hai fatto in questa sessione"
            ((WARNINGS++))
        else
            echo -e "${GREEN}OK:${NC} stato.md aggiornato oggi"
        fi
    else
        echo -e "${GREEN}OK:${NC} stato.md incluso nel commit"
    fi
fi

# =================================================================
# 4. VERIFICA COMPLIANCE MARKER (WARNING per ora)
# =================================================================

echo ""
echo ">> Verificando compliance marker..."

for file in $STAGED_FILES; do
    # Solo report in .sncp/progetti/*/reports/
    if [[ "$file" == .sncp/progetti/*/reports/*.md ]]; then
        if [ -f "$file" ]; then
            # Verifica presenza marker COSTITUZIONE-APPLIED
            if ! grep -q "COSTITUZIONE-APPLIED:" "$file" 2>/dev/null; then
                echo -e "${YELLOW}WARNING:${NC} Report senza marker COSTITUZIONE-APPLIED: $(basename "$file")"
                echo "        Agenti devono includere: COSTITUZIONE-APPLIED: SI/NO"
                ((WARNINGS++))
            fi
        fi
    fi
done

# =================================================================
# RISULTATO
# =================================================================

echo ""
echo "=================================================="

if [ "$ERRORS" -gt 0 ]; then
    echo -e "${RED}COMMIT BLOCCATO!${NC}"
    echo "  Errori: $ERRORS"
    echo "  Warning: $WARNINGS"
    echo ""
    echo "Risolvi gli errori e riprova."
    echo "=================================================="
    exit 1
fi

if [ "$WARNINGS" -gt 0 ]; then
    echo -e "${YELLOW}COMMIT OK (con $WARNINGS warning)${NC}"
else
    echo -e "${GREEN}COMMIT OK${NC}"
fi
echo "=================================================="
echo ""

exit 0
