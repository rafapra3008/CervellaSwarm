{
  "audit": {
    "analista": "Cervella Ingegnera",
    "data": "2026-01-16",
    "progetto": "Miracollo PMS",
    "health_score": "8/10",
    "verdetto": "Sistema SOLIDO con architettura matura, ma GAP EVIDENTI in FATTURAZIONE"
  },
  "moduli_analizzati": {
    "rates": {
      "file": "routers/rates.py",
      "righe": 309,
      "completezza": "85%",
      "status": "COMPLETO",
      "funzionalita": [
        "CRUD stagioni",
        "Matrice prezzi",
        "Bulk update",
        "Generate daily_rates da stagione",
        "Lookup prezzo",
        "Lista room_types e rate_plans"
      ],
      "endpoint": [
        "GET/POST /api/seasons",
        "PUT/DELETE /api/seasons/{id}",
        "GET /api/rates/matrix",
        "POST /api/rates/bulk-update",
        "POST /api/seasons/{id}/generate-rates",
        "GET /api/rates/lookup",
        "GET /api/room_types",
        "GET /api/rate_plans"
      ],
      "gap": [
        "NO derived rates (LOS pricing, early bird)",
        "NO rate restrictions (CTA, CTD, max_stay)",
        "NO BAR calculator"
      ]
    },
    "rateboard": {
      "file": "routers/rateboard.py",
      "righe": 579,
      "completezza": "90%",
      "status": "AVANZATO",
      "funzionalita": [
        "Matrice mensile heatmap",
        "Bulk update validato",
        "AI Suggestions REALI",
        "Confronto YoY",
        "Prezzi competitor con mapping"
      ],
      "endpoint": [
        "GET /api/rateboard/matrix/{year}/{month}",
        "PUT /api/rateboard/bulk-update",
        "GET /api/rateboard/suggestions",
        "GET /api/rateboard/yoy/{date}",
        "GET /api/rateboard/competitors"
      ],
      "gap": [
        "NO integrazione ML models",
        "NO forecast demand",
        "NO ottimizzazione automatica prezzi"
      ]
    },
    "rateboard_ai": {
      "file": "services/rateboard_ai.py",
      "righe": 318,
      "completezza": "85%",
      "status": "PRODUZIONE-READY",
      "funzionalita": [
        "Analisi pattern storici (weekday, month)",
        "Identificazione eventi speciali",
        "Confronto YoY con delta",
        "Suggerimenti weekend",
        "Detection bassa domanda con promozioni"
      ],
      "algoritmo": {
        "step_1": "Analizza pattern storici",
        "step_2": "Identifica eventi speciali",
        "step_3": "Genera suggerimenti (weekend, eventi, bassa domanda, YoY)",
        "step_4": "Ordina per priorità (HIGH/MEDIUM/LOW)"
      },
      "gap": [
        "NO ML predictions (solo pattern storici)",
        "NO integrazione dati meteo",
        "NO personalizzazione per hotel"
      ]
    },
    "payments": {
      "file": "routers/payments.py",
      "righe": 311,
      "completezza": "70%",
      "status": "BASE",
      "funzionalita": [
        "Lista pagamenti con filtri",
        "Crea pagamento + sync booking",
        "Update con IMMUTABLE GUARD",
        "Soft-delete con IMMUTABLE GUARD",
        "Genera link pagamento (simulato)",
        "Audit log automatico",
        "Auto-update booking payment_status"
      ],
      "endpoint": [
        "GET /api/payments",
        "POST /api/payments",
        "PUT /api/payments/{id}",
        "DELETE /api/payments/{id}",
        "POST /api/payments/link/{booking_id}"
      ],
      "gap_critici": [
        "NESSUNA FATTURAZIONE (solo payments, NO invoices)",
        "NO split payments (anticipo + saldo)",
        "NO refund workflow",
        "NO payment reminders",
        "Link pagamento simulato (non Stripe REALE)"
      ]
    },
    "stripe_service": {
      "file": "services/stripe_service.py",
      "righe": 299,
      "completezza_codice": "80%",
      "completezza_integrazione": "0%",
      "status": "SCRITTO MA NON USATO",
      "funzionalita": [
        "create_checkout_session()",
        "verify_webhook_signature()",
        "process_checkout_completed()",
        "create_refund()",
        "get_bank_transfer_info()",
        "is_stripe_configured()"
      ],
      "problema": "Service COMPLETO ma NON chiamato da payments.py, NON chiamato da bookings.py, NON integrato in workflow"
    },
    "pagonline": {
      "directory": "services/pagonline/",
      "file_totali": 5,
      "dimensione_totale": "28K",
      "completezza_codice": "70%",
      "completezza_integrazione": "0%",
      "status": "CLIENT PRONTO MA NON INTEGRATO",
      "file": {
        "client.py": "18K",
        "exceptions.py": "892B",
        "models.py": "2.1K",
        "signature.py": "6.8K"
      },
      "problema": "NON chiamato da nessuna parte, NO endpoint API, NO workflow booking"
    },
    "receipts": {
      "file": "routers/receipts.py",
      "righe": 309,
      "completezza": "50%",
      "status": "PREVIEW ONLY",
      "funzionalita": [
        "Preview dati JSON ricevuta",
        "Verifica disponibilità",
        "Calcolo totali (room + city_tax)",
        "Breakdown pagamenti",
        "Numero ricevuta progressivo {year}/{booking_id}",
        "Formattazione italiana"
      ],
      "endpoint": [
        "GET /api/receipts/booking/{id}/preview",
        "GET /api/receipts/booking/{id}/exists"
      ],
      "gap_critici": [
        "NO GENERAZIONE PDF (solo dati JSON)",
        "NO template ricevuta",
        "NO invio email automatico",
        "NO archiviazione ricevute",
        "Numero progressivo NON unico (usa booking_id)"
      ]
    },
    "city_tax": {
      "file": "routers/city_tax.py",
      "righe": 720,
      "completezza": "95%",
      "status": "COMPLETO E COMPLIANCE-READY",
      "funzionalita": [
        "Configurazione tariffe",
        "Gestione esenzioni",
        "Calcolo automatico",
        "Apply e salva charges",
        "Riscossione tracking",
        "Esenzione manuale",
        "Report riepilogativo",
        "Export CSV per commercialista",
        "Lista pending da riscuotere"
      ],
      "endpoint": [
        "GET/PUT /api/city-tax/config",
        "GET/POST/DELETE /api/city-tax/exemptions",
        "GET /api/city-tax/calculate/{booking_id}",
        "POST /api/city-tax/apply/{booking_id}",
        "GET /api/city-tax/charges/{booking_id}",
        "POST /api/city-tax/collect/{booking_id}",
        "POST /api/city-tax/exempt/{booking_id}",
        "GET /api/city-tax/report/summary",
        "GET /api/city-tax/report/export",
        "GET /api/city-tax/pending"
      ],
      "gap": [
        "NO integrazione SIATEL (sistema ufficiale Comune)",
        "NO reminder riscossione automatica"
      ]
    },
    "analytics": {
      "file": "routers/analytics.py",
      "righe": 178,
      "completezza": "40%",
      "status": "DEBUG MODE",
      "funzionalita": [
        "Log errori JavaScript frontend",
        "Batch azioni utente",
        "Stats rapide (24h)",
        "Activity feed sidebar"
      ],
      "endpoint": [
        "POST /api/logs/error",
        "POST /api/logs/actions",
        "GET /api/logs/stats",
        "GET /api/logs/actions/recent"
      ],
      "problema": "NON è revenue analytics, è solo logging DEBUG frontend",
      "gap": [
        "MANCA revenue analytics reale",
        "MANCA channel performance",
        "MANCA rate performance by room type",
        "MANCA forecast vs actual",
        "MANCA market segment analysis"
      ]
    },
    "dashboard": {
      "file": "routers/dashboard.py",
      "righe": 517,
      "completezza": "85%",
      "status": "KPI AVANZATI",
      "funzionalita": [
        "Stats base giornaliere",
        "KPI Premium con delta (occupancy, ADR, RevPAR)",
        "Liste dettagliate arrivals/departures/in-house",
        "Confronto vs ieri/settimana/mese",
        "Operational metrics (arrivals, departures, pickup, pending_amount)"
      ],
      "endpoint": [
        "GET /api/dashboard/{hotel_code}",
        "GET /api/dashboard/{hotel_code}/kpis",
        "GET /api/dashboard/{hotel_code}/today"
      ],
      "kpi": [
        "occupancy",
        "ADR (Average Daily Rate)",
        "RevPAR (Revenue Per Available Room)"
      ],
      "gap": [
        "NO forecast occupancy",
        "NO pace report",
        "NO segment breakdown"
      ]
    },
    "reports": {
      "file": "routers/reports.py",
      "righe": 223,
      "completezza": "30%",
      "status": "ISTAT ONLY",
      "funzionalita": [
        "Export CSV ISTAT",
        "Preview statistiche ISTAT"
      ],
      "endpoint": [
        "GET /api/reports/istat-export",
        "GET /api/reports/istat-stats"
      ],
      "gap_critici": [
        "SOLO export ISTAT",
        "MANCANO Revenue Report",
        "MANCANO P&L (Profit & Loss)",
        "MANCANO Cash Flow",
        "MANCANO Tax Summary",
        "MANCANO Channel Performance",
        "MANCANO Rate Performance",
        "MANCANO Forecast vs Actual",
        "MANCANO Budget vs Actual",
        "MANCANO Market Segment",
        "MANCANO Source of Business"
      ]
    },
    "pricing_tracking": {
      "file": "routers/pricing_tracking.py",
      "righe": 446,
      "completezza": "85%",
      "status": "INNOVATIVO",
      "funzionalita": [
        "Timeline cambi prezzo",
        "Log cambio prezzo",
        "Performance AI suggestion",
        "Dashboard salute AI"
      ],
      "endpoint": [
        "GET /api/pricing/history",
        "POST /api/pricing/history",
        "GET /api/pricing/suggestions/{id}/performance",
        "GET /api/pricing/ai-health"
      ],
      "metriche": {
        "status": ["EVALUATING", "SUCCESS", "NEUTRAL", "WARNING", "FAILURE"],
        "tracked": ["RevPAR delta %", "Occupancy delta %", "ADR delta %", "Performance score (0-100)"]
      }
    },
    "pricing_tracking_service": {
      "file": "services/pricing_tracking_service.py",
      "righe": 588,
      "completezza": "90%",
      "status": "ENTERPRISE-LEVEL",
      "funzionalita": [
        "Log price change",
        "Start performance evaluation",
        "Calculate evaluation window (6-168h)",
        "Complete evaluation con score",
        "Finestra adattiva basata su urgency/volatility/velocity"
      ],
      "algoritmo_valutazione": {
        "step_1": "Log price change in pricing_history",
        "step_2": "Start evaluation (window dinamica, baseline snapshot)",
        "step_3": "Background job completa dopo window",
        "step_4": "Calcola score (0-100) e status"
      },
      "finestra_adattiva": {
        "base": "24h",
        "urgency_multiplier": "0.5-3.0 (giorni a arrivo)",
        "volatility_multiplier": "0.5-1.25 (cambi recenti)",
        "velocity_multiplier": "0.5-1.25 (pickup velocity)",
        "range": "6h - 168h (7 giorni)"
      },
      "performance_score": {
        "formula": "revpar_performance (50%) + balance_score (30%) + pickup_score (20%)",
        "status_thresholds": {
          "SUCCESS": "≥80",
          "NEUTRAL": "60-79",
          "WARNING": "40-59",
          "FAILURE": "<40"
        }
      }
    },
    "ml": {
      "directory": "ml/",
      "file_totali": 5,
      "dimensione_totale": "~98K",
      "completezza_codice": "80%",
      "completezza_integrazione": "0%",
      "status": "PREPARATO MA NON INTEGRATO",
      "file": {
        "confidence_scorer.py": "25K",
        "data_preparation.py": "14K",
        "feature_engineering.py": "15K",
        "ml_scheduler.py": "21K",
        "model_trainer.py": "23K"
      },
      "problema": "NON chiamato da rateboard_ai.py, NON usato per suggestions, Modelli ML NON trainati, NO predictions in produzione"
    }
  },
  "statistiche": {
    "totale_righe_analizzate": 3283,
    "totale_file_analizzati": 15,
    "health_score": 8,
    "breakdown_completezza": {
      "eccellente_90_plus": {
        "count": 4,
        "percentuale": "27%",
        "moduli": ["rateboard", "rateboard_analytics", "city_tax", "pricing_tracking_service"]
      },
      "buono_80_89": {
        "count": 5,
        "percentuale": "33%",
        "moduli": ["rates", "rateboard_ai", "dashboard", "pricing_tracking"]
      },
      "sufficiente_60_79": {
        "count": 3,
        "percentuale": "20%",
        "moduli": ["payments", "pagonline", "stripe_service"]
      },
      "incompleto_under_60": {
        "count": 3,
        "percentuale": "20%",
        "moduli": ["receipts", "analytics", "reports"]
      }
    },
    "technical_debt": {
      "alto": ["Fatturazione completa", "Receipts PDF generation"],
      "medio": ["Reports expansion", "Analytics revenue reale"],
      "basso": ["ML integration", "Advanced pricing"]
    }
  },
  "gap_critici": [
    {
      "priorita": "ALTA",
      "titolo": "FATTURAZIONE COMPLETA",
      "dettagli": [
        "Generazione fatture elettroniche XML",
        "Numerazione progressiva legale",
        "Invio SDI (Sistema Di Interscambio)",
        "Note di credito",
        "Registro fatture",
        "Export per commercialista"
      ]
    },
    {
      "priorita": "ALTA",
      "titolo": "RECEIPTS PDF GENERATION",
      "dettagli": [
        "Template HTML ricevuta",
        "Generazione PDF (WeasyPrint/ReportLab)",
        "Archiviazione PDF generati",
        "Invio email automatico",
        "Numerazione progressiva VERA"
      ]
    },
    {
      "priorita": "ALTA",
      "titolo": "STRIPE/PAGONLINE INTEGRATION",
      "dettagli": [
        "Decidere quale usare (o entrambi)",
        "Link nei workflow booking",
        "Webhook handling",
        "Payment reconciliation",
        "Rimuovere quello non usato"
      ]
    },
    {
      "priorita": "MEDIA",
      "titolo": "REVENUE ANALYTICS",
      "dettagli": [
        "Channel performance",
        "Rate performance by room type",
        "Forecast vs actual",
        "Market segment analysis",
        "Source of business"
      ]
    },
    {
      "priorita": "MEDIA",
      "titolo": "REPORTS EXPANSION",
      "dettagli": [
        "Revenue Report",
        "P&L (Profit & Loss)",
        "Cash Flow",
        "Tax Summary",
        "Budget vs Actual"
      ]
    },
    {
      "priorita": "BASSA",
      "titolo": "ML ACTIVATION o REMOVAL",
      "dettagli": [
        "Attivare modelli ML per predictions",
        "Train modelli con dati storici",
        "Integrare in rateboard_ai",
        "OPPURE rimuovere codice ML se non usato"
      ]
    }
  ],
  "raccomandazioni_architetturali": [
    {
      "area": "Payments/Invoicing",
      "proposta": "Separare in moduli distinti: payments.py, invoicing.py, receipts.py, reconciliation.py"
    },
    {
      "area": "Reports",
      "proposta": "Modularizzare in: istat.py, revenue.py, financial.py, tax.py, operational.py"
    },
    {
      "area": "Payment Providers",
      "proposta": "Creare abstraction layer con PaymentProvider base class e implementations per Stripe/PagOnline"
    }
  ],
  "punti_forza": [
    "Rateboard AI con logica REALE intelligente (non mockup)",
    "Pricing Tracking innovativo (livello enterprise)",
    "City Tax compliance-ready con export ISTAT",
    "Dashboard KPI avanzata con delta vs periodi precedenti",
    "IMMUTABLE GUARD per compliance fiscale italiana",
    "Finestra valutazione adattiva per AI suggestions"
  ],
  "prossimi_step": [
    {
      "priorita": 1,
      "urgenza": "URGENTE",
      "task": "Implementare FATTURAZIONE completa con XML e SDI"
    },
    {
      "priorita": 2,
      "urgenza": "ALTA",
      "task": "Aggiungere PDF generation per receipts"
    },
    {
      "priorita": 3,
      "urgenza": "ALTA",
      "task": "Decidere e integrare payment provider (Stripe o PagOnline)"
    },
    {
      "priorita": 4,
      "urgenza": "MEDIA",
      "task": "Espandere modulo Reports con revenue/financial"
    },
    {
      "priorita": 5,
      "urgenza": "BASSA",
      "task": "Attivare o rimuovere ML infrastructure"
    }
  ]
}
